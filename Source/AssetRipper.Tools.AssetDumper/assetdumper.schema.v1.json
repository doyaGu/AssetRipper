{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://joern.io/schemas/assetdump/v2-lean.schema.json",
  "title": "AssetDump v2-lean Documents",
  "description": "Schema definitions for AssetRipper AssetDump v2-lean manifest, NDJSON record shards, and optional key index sidecars.",
  "oneOf": [
    { "$ref": "#/$defs/Manifest" },
    { "$ref": "#/$defs/AssetRecord" },
    { "$ref": "#/$defs/DependencyRecord" },
    { "$ref": "#/$defs/SceneRecord" },
    { "$ref": "#/$defs/ScriptMetadataRecord" },
    { "$ref": "#/$defs/BundleMetadataRecord" },
    { "$ref": "#/$defs/KeyIndexDocument" }
  ],
  "$defs": {
    "HexId": {
      "type": "string",
      "pattern": "^[A-F0-9]{8}$",
      "description": "Uppercase 8-character hexadecimal identifier (collectionId, resourceId, etc.)."
    },
    "Timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp in extended ISO-8601 format (e.g. 2025-10-31T16:00:00Z)."
    },
    "StableKey": {
      "type": "string",
      "pattern": "^[A-F0-9]{8}:-?\\d+$",
      "description": "Composite key '<collectionId>:<pathID>' used for fast lookups."
    },
    "Domain": {
      "type": "string",
      "description": "Logical dataset grouping for sharded NDJSON exports. Values follow table identifiers (e.g., facts/assets, facts/script_metadata)."
    },
    "CompressionCodec": {
      "type": "string",
      "enum": ["none", "zstd", "zstd-seekable", "gzip"],
      "description": "Compression applied to the shard. Prefer zstd or zstd-seekable for parallel reads."
    },
    "AssetRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["c", "p"],
      "properties": {
        "c": {
          "$ref": "#/$defs/HexId",
          "description": "Collection identifier that owns the asset."
        },
        "p": {
          "type": "integer",
          "description": "PathID within the referenced collection."
        }
      },
      "description": "Structured reference to a Unity asset (collectionId + pathID)."
    },
    "NullableAssetRef": {
      "description": "Optional Unity asset reference; null indicates an unresolved or missing target.",
      "anyOf": [
        { "$ref": "#/$defs/AssetRef" },
        { "type": "null" }
      ]
    },
    "AssetRefList": {
      "type": "array",
      "items": { "$ref": "#/$defs/AssetRef" },
      "default": [],
      "description": "Ordered collection of structured asset references."
    },
    "ShardDescriptor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["domain", "shard", "records", "bytes"],
      "properties": {
        "domain": { "$ref": "#/$defs/Domain" },
        "shard": {
          "type": "string",
          "description": "Shard filename (e.g. assets-000.jsonl or assets-000.jsonl.zst)."
        },
        "records": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of NDJSON records written to the shard."
        },
        "bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Size on disk in bytes (compressed size when compression != none)."
        },
        "uncompressedBytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Logical byte size prior to compression (for seekable formats)."
        },
        "compression": { "$ref": "#/$defs/CompressionCodec" },
        "frameSize": {
          "type": "integer",
          "minimum": 0,
          "description": "Seekable frame size in bytes for zstd-seekable shards."
        },
        "sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$",
          "description": "SHA-256 digest of the shard contents (lower or upper hex)."
        },
        "firstKey": {
          "$ref": "#/$defs/StableKey",
          "description": "Lowest stable key contained in the shard (lexicographic)."
        },
        "lastKey": {
          "$ref": "#/$defs/StableKey",
          "description": "Highest stable key contained in the shard (lexicographic)."
        }
      }
    },
    "IndexRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "path"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["kindex", "sqlite", "custom"],
          "description": "Index implementation backing the lookup table."
        },
        "path": {
          "type": "string",
          "description": "Filesystem path to the index payload relative to the export root."
        },
        "domain": { "$ref": "#/$defs/Domain" },
        "records": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of indexed keys stored in the sidecar."
        },
        "createdAt": { "$ref": "#/$defs/Timestamp" }
      }
    },
    "BehaviourInfo": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["ManagerUnavailable", "Resolved", "ResolutionFailed", "Unresolved"],
          "description": "Resolution state for a MonoBehaviour's serialized type."
        },
        "message": {
          "type": "string",
          "description": "Diagnostic details captured during behaviour resolution."
        },
        "type": {
          "type": "object",
          "additionalProperties": false,
          "required": ["fullName", "namespace", "name", "isPrimitive", "isEngineStruct", "isEnginePointer"],
          "properties": {
            "fullName": { "type": "string" },
            "namespace": { "type": "string" },
            "name": { "type": "string" },
            "primitiveKind": { "type": "string" },
            "isPrimitive": { "type": "boolean" },
            "isEngineStruct": { "type": "boolean" },
            "isEnginePointer": { "type": "boolean" },
            "maxDepth": { "type": "integer" },
            "fields": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["name", "arrayDepth", "align", "isArray", "type"],
                "properties": {
                  "name": { "type": "string" },
                  "arrayDepth": { "type": "integer", "minimum": 0 },
                  "align": { "type": "boolean" },
                  "isArray": { "type": "boolean" },
                  "type": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": ["fullName", "namespace", "name", "primitiveKind", "isPrimitive", "isEngineStruct", "isEnginePointer"],
                    "properties": {
                      "fullName": { "type": "string" },
                      "namespace": { "type": "string" },
                      "name": { "type": "string" },
                      "primitiveKind": { "type": "string" },
                      "isPrimitive": { "type": "boolean" },
                      "isEngineStruct": { "type": "boolean" },
                      "isEnginePointer": { "type": "boolean" }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "description": "Optional behavioural metadata emitted for MonoBehaviour scripts."
    },
    "SceneCollectionDescriptor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["collectionId", "name"],
      "properties": {
        "collectionId": { "$ref": "#/$defs/HexId" },
        "name": { "type": "string" },
        "bundleName": { "type": "string" },
        "collectionType": { "type": "string" },
        "filePath": { "type": "string" },
        "version": { "type": "string" },
        "platform": { "type": "string" },
        "flags": { "type": "string" },
        "isProcessed": { "type": "boolean" },
        "isSceneCollection": { "type": "boolean" },
        "sceneName": { "type": "string" },
        "isPrimary": { "type": "boolean" }
      }
    },
    "Manifest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["format", "version", "createdAt", "files"],
      "properties": {
        "format": { "type": "string", "const": "assetdump-ndjson" },
        "version": { "type": "string", "const": "2-lean" },
        "createdAt": { "$ref": "#/$defs/Timestamp" },
        "tool": { "type": "string", "description": "Authoring tool identifier (e.g. AssetRipper.Tools.AssetDumper)." },
        "toolVersion": { "type": "string" },
        "assetRipperVersion": { "type": "string" },
        "unityVersion": { "type": "string" },
        "projectName": { "type": "string" },
        "projectGuid": { "type": "string" },
        "files": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/ShardDescriptor" }
        },
        "index": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "assets": { "$ref": "#/$defs/IndexRef" },
            "deps": { "$ref": "#/$defs/IndexRef" },
            "scenes": { "$ref": "#/$defs/IndexRef" },
            "scripts": { "$ref": "#/$defs/IndexRef" }
          }
        },
        "metadata": {
          "type": "object",
          "description": "Exporter-specific metadata bag.",
          "additionalProperties": true
        }
      }
    },
    "AssetRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": ["domain", "k", "c", "p", "classID", "className"],
      "properties": {
        "domain": { "type": "string", "const": "assets" },
        "k": { "$ref": "#/$defs/StableKey" },
        "c": { "$ref": "#/$defs/HexId" },
        "p": { "type": "integer" },
        "classID": { "type": "integer" },
        "className": { "type": "string" },
        "bestName": { "type": "string" },
        "collection": { "type": "string", "description": "Human readable collection name." },
        "collectionType": { "type": "string" },
        "bundleName": { "type": "string" },
        "assetBundleName": { "type": "string" },
        "originalPath": { "type": "string" },
        "labels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional tag set associated with the asset."
        },
        "isScene": { "type": "boolean" },
        "isStripped": { "type": "boolean" },
        "isHidden": { "type": "boolean" },
        "data": {
          "description": "Serialized Unity object payload when inline export is enabled.",
          "type": ["object", "array", "string", "number", "boolean", "null"]
        },
        "notes": { "type": "string" }
      }
    },
    "DependencyRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": ["domain", "owner", "field", "fileID", "pathID"],
      "properties": {
        "domain": { "type": "string", "const": "deps" },
        "owner": { "$ref": "#/$defs/AssetRef" },
        "ownerKey": { "$ref": "#/$defs/StableKey" },
        "field": { "type": "string", "description": "Serialized field or slot that holds the reference." },
        "fileID": { "type": "integer", "description": "Unity file index within the owning collection." },
        "pathID": { "type": "integer", "description": "Target pathID as stored in the serialized data." },
        "target": { "$ref": "#/$defs/NullableAssetRef" },
        "targetKey": { "$ref": "#/$defs/StableKey" },
        "targetCollection": { "type": "string" },
        "targetCollectionId": { "$ref": "#/$defs/HexId" },
        "status": {
          "type": "string",
          "enum": ["Resolved", "Missing", "SelfReference", "External"],
          "description": "Resolution status for the dependency edge."
        },
        "isNull": { "type": "boolean" },
        "notes": { "type": "string" }
      }
    },
    "SceneRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "domain",
        "name",
        "sceneGuid",
        "scenePath",
        "exportedAt",
        "collectionId",
        "collection",
        "version",
        "platform",
        "sceneCollectionCount",
        "collectionIds",
        "hierarchy",
        "hierarchyAssetId",
        "pathID",
        "classID",
        "className",
        "assetCount",
        "gameObjectCount",
        "componentCount",
        "managerCount",
        "prefabInstanceCount",
        "dependencyCount",
        "rootGameObjectCount",
        "strippedAssetCount",
        "hiddenAssetCount",
        "hasSceneRoots"
      ],
      "properties": {
        "domain": { "type": "string", "const": "scenes" },
        "type": { "type": "string", "const": "Scene" },
        "name": { "type": "string" },
        "sceneGuid": {
          "type": "string",
          "pattern": "^[0-9A-Fa-f]{32}$|^[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}$"
        },
        "scenePath": { "type": "string" },
        "exportedAt": { "$ref": "#/$defs/Timestamp" },
        "collectionId": { "$ref": "#/$defs/HexId" },
        "collection": {
          "type": "string",
          "description": "Primary processed collection that hosts the SceneHierarchyObject."
        },
        "version": { "type": "string" },
        "platform": { "type": "string" },
        "flags": { "type": "string" },
        "endianType": { "type": "string" },
        "bundleName": { "type": "string" },
        "assetBundleName": { "type": "string" },
        "sceneCollectionCount": { "type": "integer", "minimum": 1 },
        "collectionIds": {
          "type": "array",
          "items": { "$ref": "#/$defs/HexId" },
          "minItems": 1,
          "uniqueItems": true
        },
        "collections": {
          "type": "array",
          "items": { "$ref": "#/$defs/SceneCollectionDescriptor" },
          "default": []
        },
        "hierarchy": { "$ref": "#/$defs/AssetRef" },
        "hierarchyAssetId": { "$ref": "#/$defs/StableKey" },
        "pathID": { "type": "integer" },
        "classID": { "type": "integer" },
        "className": { "type": "string" },
        "assetCount": { "type": "integer", "minimum": 0 },
        "gameObjectCount": { "type": "integer", "minimum": 0 },
        "componentCount": { "type": "integer", "minimum": 0 },
        "managerCount": { "type": "integer", "minimum": 0 },
        "prefabInstanceCount": { "type": "integer", "minimum": 0 },
        "dependencyCount": { "type": "integer", "minimum": 0 },
        "hasSceneRoots": { "type": "boolean" },
        "rootGameObjectCount": { "type": "integer", "minimum": 0 },
        "strippedAssetCount": { "type": "integer", "minimum": 0 },
        "hiddenAssetCount": { "type": "integer", "minimum": 0 },
        "sceneRootsAsset": { "$ref": "#/$defs/NullableAssetRef" },
        "sceneRoots": { "$ref": "#/$defs/AssetRefList" },
        "rootGameObjects": { "$ref": "#/$defs/AssetRefList" },
        "gameObjects": { "$ref": "#/$defs/AssetRefList" },
        "components": { "$ref": "#/$defs/AssetRefList" },
        "managers": { "$ref": "#/$defs/AssetRefList" },
        "prefabInstances": { "$ref": "#/$defs/AssetRefList" },
        "strippedAssets": { "$ref": "#/$defs/AssetRefList" },
        "hiddenAssets": { "$ref": "#/$defs/AssetRefList" },
        "notes": { "type": "string" }
      }
    },
    "ScriptMetadataRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "pk",
        "collectionId",
        "pathId",
        "classId",
        "className",
        "fullName",
        "assemblyName"
      ],
      "properties": {
        "pk": {
          "type": "string",
          "pattern": "^[A-F0-9]{8}$"
        },
        "collectionId": { "$ref": "#/$defs/HexId" },
        "collectionName": { "type": "string" },
        "bundleName": { "type": "string" },
        "collectionFlags": { "type": "string" },
        "collectionPlatform": { "type": "string" },
        "collectionVersion": { "type": "string" },
        "collectionFilePath": { "type": "string" },
        "isSceneCollection": { "type": "boolean" },
        "pathId": { "type": "integer" },
        "classId": { "type": "integer" },
        "className": { "type": "string" },
        "fullName": { "type": "string" },
        "namespace": { "type": "string" },
        "assemblyName": { "type": "string" },
        "executionOrder": { "type": "integer" },
        "scriptGuid": { "type": "string" },
        "assemblyGuid": { "type": "string" },
        "scriptFileId": { "type": "integer" },
        "propertiesHash": { "type": "string" },
        "scene": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string" },
            "path": { "type": "string" },
            "guid": { "type": "string" }
          }
        }
      }
    },
    "BundleMetadataRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "pk",
        "name",
        "bundleType",
        "isRoot",
        "hierarchyDepth",
        "hierarchyPath",
        "directCollectionCount",
        "totalCollectionCount",
        "directSceneCollectionCount",
        "totalSceneCollectionCount",
        "directChildBundleCount",
        "totalChildBundleCount",
        "directResourceCount",
        "totalResourceCount",
        "directFailedFileCount",
        "totalFailedFileCount",
        "directAssetCount",
        "totalAssetCount"
      ],
      "properties": {
        "pk": { "$ref": "#/$defs/StableKey" },
        "name": { "type": "string" },
        "bundleType": { "type": "string" },
        "parentPk": {
          "type": "string",
          "pattern": "^[A-F0-9]{8}$"
        },
        "isRoot": { "type": "boolean" },
        "hierarchyDepth": { "type": "integer", "minimum": 0 },
        "hierarchyPath": { "type": "string" },
        "collectionIds": {
          "type": "array",
          "items": { "$ref": "#/$defs/HexId" },
          "uniqueItems": true
        },
        "resources": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name"],
            "properties": {
              "name": { "type": "string" },
              "filePath": { "type": "string" }
            }
          }
        },
        "directCollectionCount": { "type": "integer", "minimum": 0 },
        "totalCollectionCount": { "type": "integer", "minimum": 0 },
        "directSceneCollectionCount": { "type": "integer", "minimum": 0 },
        "totalSceneCollectionCount": { "type": "integer", "minimum": 0 },
        "directChildBundleCount": { "type": "integer", "minimum": 0 },
        "totalChildBundleCount": { "type": "integer", "minimum": 0 },
        "directResourceCount": { "type": "integer", "minimum": 0 },
        "totalResourceCount": { "type": "integer", "minimum": 0 },
        "directFailedFileCount": { "type": "integer", "minimum": 0 },
        "totalFailedFileCount": { "type": "integer", "minimum": 0 },
        "directAssetCount": { "type": "integer", "minimum": 0 },
        "totalAssetCount": { "type": "integer", "minimum": 0 }
      }
    },
    "KeyIndexEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key", "shard", "offset", "length"],
      "properties": {
        "key": { "$ref": "#/$defs/StableKey" },
        "shard": { "type": "string" },
        "offset": { "type": "integer", "minimum": 0 },
        "length": { "type": "integer", "minimum": 1 },
        "line": {
          "type": "integer",
          "minimum": 0,
          "description": "Optional 0-based line number within the shard."
        },
        "frame": {
          "type": "integer",
          "minimum": 0,
          "description": "Seekable compression frame index containing the record."
        }
      }
    },
    "KeyIndexDocument": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "domain", "entries"],
      "properties": {
        "kind": { "type": "string", "const": "kindex" },
        "domain": { "$ref": "#/$defs/Domain" },
        "createdAt": { "$ref": "#/$defs/Timestamp" },
        "entries": {
          "type": "array",
          "items": { "$ref": "#/$defs/KeyIndexEntry" }
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Implementation-specific metadata for the index writer."
        }
      }
    }
  }
}
